<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HF File Frontend</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
html,body{
  height:100%;margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  background:#f5f7fa;
}
body{display:flex;flex-direction:column}

#controls{
  display:flex;flex-wrap:wrap;gap:6px;align-items:center;
  padding:8px 10px;
  background:#fff;
  border-bottom:1px solid #ddd;
}

#controls label{font-size:12px;font-weight:600;color:#444}
#controls select,#controls input{
  font-size:12px;padding:5px 6px;
  border:1px solid #ccc;border-radius:4px;
}
#controls button{
  padding:6px 12px;font-size:12px;
  border:none;border-radius:4px;
  background:#4f46e5;color:#fff;font-weight:600;
  cursor:pointer;
}
#controls button:disabled{opacity:.6}

#status{
  margin-left:auto;
  font-family:monospace;
  font-size:12px;
  background:#eef2ff;
  padding:4px 6px;
  border-radius:4px;
  white-space:nowrap;
}

#response{
  flex:1;
  background:#fff;
  margin:6px;
  border-radius:6px;
  border:1px solid #ccc;
  overflow:auto;
  padding:8px;
}

/* tables */
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ccc;padding:4px 6px;font-size:12px}
th{background:#f1f5f9}

/* pdf */
canvas{display:block;margin:10px auto;box-shadow:0 0 6px rgba(0,0,0,.3)}

/* image */
#response img{
  max-width:100%;
  display:block;
  margin:auto;
}
</style>
</head>

<body>

<div id="controls">
  <label>Mode</label>
  <select id="mode">
    <option value="stock">stock</option>
    <option value="index">index</option>
    <option value="screener">screener</option>
  </select>

  <label>Req</label>
  <select id="req_type"></select>

  <label>Name</label>
  <input id="name" style="width:90px">

  <label>From</label>
  <input id="date_start" style="width:90px">

  <label>To</label>
  <input id="date_end" style="width:90px">

  <label>Suffix</label>
  <input id="suffix" style="width:80px">

  <button id="fetchBtn" onclick="fetchFile()">Fetch</button>

  <div id="status">idle</div>
</div>

<div id="response"></div>

<script>
/* ---------------- CONFIG ---------------- */
const HF_API = "https://eshan6704-hfapp.hf.space";

/* ---------------- REQ TYPES (HARDCODED) ---------------- */
const REQ_TYPES = {
  stock: [
    "info","intraday","daily","nse_eq","qresult","result",
    "balance","cashflow","dividend","split","other","stock_hist"
  ],
  index: [
    "indices","open","preopen","fno","fiidii","events",
    "index_highlow","stock_highlow","bhav","largedeals",
    "bulkdeals","blockdeals","most_active","index_history",
    "hlargedeals","pe_pb","total_returns"
  ],
  screener: ["from_low","from_high","volume","delivery"]
};

/* ---------------- ELEMENTS ---------------- */
const mode=document.getElementById("mode");
const req_type=document.getElementById("req_type");
const name=document.getElementById("name");
const date_start=document.getElementById("date_start");
const date_end=document.getElementById("date_end");
const suffix=document.getElementById("suffix");
const statusBar=document.getElementById("status");
const response=document.getElementById("response");
const fetchBtn=document.getElementById("fetchBtn");

/* ---------------- HELPERS ---------------- */
function nowTime(){
  return new Date().toLocaleTimeString("en-IN",{hour12:false});
}
function fyStart(){
  const d=new Date();
  const y=d.getMonth()>=3?d.getFullYear():d.getFullYear()-1;
  return `01-04-${y}`;
}
function today(){
  const d=new Date();
  return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
}
function setStatus(t){statusBar.textContent=t}

/* ---------------- DEFAULTS ---------------- */
function updateReqTypes(){
  req_type.innerHTML="";
  REQ_TYPES[mode.value].forEach(r=>{
    const o=document.createElement("option");
    o.value=r;
    o.textContent=r.toUpperCase();
    if(
      (mode.value==="stock" && r==="info") ||
      (mode.value==="index" && r==="indices") ||
      (mode.value==="screener" && r==="from_low")
    ) o.selected=true;
    req_type.appendChild(o);
  });

  if(mode.value==="stock"){
    name.value="ITC";
    date_start.value=fyStart();
    date_end.value=today();
  }else if(mode.value==="index"){
    name.value="NIFTY 50";
    date_start.value=fyStart();
    date_end.value=today();
  }else{
    name.value="";
    date_start.value="";
    date_end.value="";
  }
  suffix.value="";
}

mode.addEventListener("change",updateReqTypes);
window.addEventListener("load",updateReqTypes);

/* ---------------- FETCH ---------------- */
async function fetchFile(){
  const m=mode.value;
  const r=req_type.value;
  const n=name.value.trim();
  const ds=date_start.value;
  const de=date_end.value;
  const s=suffix.value.trim();

  let fname=`@${m}@${r}`;
  if(n) fname+=`@${n}`;
  if(de) fname+=`@${de}`;
  if(ds) fname+=`@${ds}`;
  if(s)  fname+=`@${s}`;
  fname+=".html";

  setStatus(`${nowTime()} | FETCHING | ${fname}`);
  fetchBtn.disabled=true;

  const t0=performance.now();
  try{
    const res=await fetch(`${HF_API}/file?name=${encodeURIComponent(fname)}`);
    const blob=await res.blob();
    const text=await blob.text();
    const dt=Math.round(performance.now()-t0);
    setStatus(`${nowTime()} | DONE | ${(blob.size/1024).toFixed(0)} KB | ${dt} ms | ${fname}`);
    renderByType(fname,blob,text);
  }catch(e){
    setStatus(`${nowTime()} | ERROR | ${fname}`);
    response.innerHTML=`<pre style="color:red">${e.message}</pre>`;
  }finally{
    fetchBtn.disabled=false;
  }
}

/* ---------------- RENDER ---------------- */
function renderByType(name,blob,text){
  response.innerHTML="";

  if(name.endsWith(".pdf")){
    loadPDF(URL.createObjectURL(blob));
    return;
  }

  if(name.match(/\.(png|jpg|jpeg)$/i)){
    const img=document.createElement("img");
    img.src=URL.createObjectURL(blob);
    response.appendChild(img);
    return;
  }

  if(name.endsWith(".json")){
    try{response.innerHTML=`<pre>${JSON.stringify(JSON.parse(text),null,2)}</pre>`;}
    catch{response.innerHTML=`<pre>${text}</pre>`}
    return;
  }

  if(name.endsWith(".csv")){
    const rows=text.trim().split("\n").map(r=>r.split(","));
    let h="<table>";
    rows.forEach((row,i)=>{
      h+="<tr>";
      row.forEach(c=>h+=i?`<td>${c}</td>`:`<th>${c}</th>`);
      h+="</tr>";
    });
    h+="</table>";
    response.innerHTML=h;
    return;
  }

  if(name.endsWith(".html")){
    response.innerHTML=text;
    return;
  }

  response.innerHTML=`<pre>${text}</pre>`;
}

/* ---------------- PDF ---------------- */
pdfjsLib.GlobalWorkerOptions.workerSrc=
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
async function loadPDF(url){
  response.innerHTML="";
  const pdf=await pdfjsLib.getDocument(url).promise;
  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const v=p.getViewport({scale:1.2});
    const c=document.createElement("canvas");
    c.width=v.width;c.height=v.height;
    response.appendChild(c);
    await p.render({canvasContext:c.getContext("2d"),viewport:v}).promise;
  }
}
</script>

</body>
</html>
